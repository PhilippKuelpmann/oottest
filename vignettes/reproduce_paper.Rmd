---
title: "Reproduce Külpmann, Kuzmics"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{reproduce_paper}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
TODO: move stuff from reproduce_paper.R in here.

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(oottest)
```


## Loading data and predictions

The data as well as the predictions from Külpmann Kuzmics (2020) are part of this package.

Access them as:
data_two_action_games (TODO: link to man page)
data_three_action_games (TODO: link to man page)
predictions_two_action_games (TODO: link to man page)
predictions_three_action_games (TODO: link to man page)


## Creating all Vuong tables

First, we have to create Vuong tables for each subset of the games we analysed.

TODO: let Vuong matrix accept arrays

```{r}
# vuong_table_two <- vuong_matrix(data_two_action_games, predictions_two_action_games)
```


## Recreating tables from the paper
### Comparison of log-likelihood differences
fig 1:
create_llr_graph_files <- function() {
  create_likelihood_tex_tables_3(game = "AC")[, -11]
  create_likelihood_tex_tables_3(game = "RSP")[, -11]
  llr_3 <- cbind(create_likelihood_tex_tables_3(game = "AC")[, -11], create_likelihood_tex_tables_3(game = "RSP")[, -11])
  llr_2 <- create_likelihood_tex_tables_2()
  llr <- cbind(llr_2, llr_3)
  # 2: NA-RA
  # 5: CH_RA <- normalized to 1
  # 9: QLK-RA
  # 11: QCH-RA

  CH_normalizer <- llr[5, ]
  NE_RA <- round(t(rbind(1:40, llr[2, ] - CH_normalizer)), 12)
  CH_RA <- round(t(rbind(1:40, llr[5, ] - CH_normalizer)), 12)
  QLK_RA <- round(t(rbind(1:40, llr[9, ] - CH_normalizer)), 12)
  QCH_RA <- round(t(rbind(1:40, llr[11, ] - CH_normalizer)), 12)
  colnames(NE_RA) <- c("treatment", "lh_diff")
  colnames(CH_RA) <- c("treatment", "lh_diff")
  colnames(QLK_RA) <- c("treatment", "lh_diff")
  colnames(QCH_RA) <- c("treatment", "lh_diff")
  write.csv(NE_RA, file = "NE_RA.csv", row.names = FALSE, quote = FALSE)
  write.csv(CH_RA, file = "CH_RA.csv", row.names = FALSE, quote = FALSE)
  write.csv(QLK_RA, file = "QLK_RA.csv", row.names = FALSE, quote = FALSE)
  write.csv(QCH_RA, file = "QCH_RA.csv", row.names = FALSE, quote = FALSE)
}

### Vuong tables
Table 1: 2-action games
create_vuong_table_2_hdg <- function() {
  # merge data
  data_2 <- hdg_data
  preds_2 <- clean_theory_predictions_2()
  for (i in 1:length(preds_2)) {
    preds_2[[i]] <- preds_2[[i]][, 1:10]
  }
  result <- vuong_matrix(data_2, theories = preds_2)
  colnames(result) <- names(preds_2)
  row.names(result) <- names(preds_2)
  return(result)
}

create_vuong_table_2_mp1 <- function() {
  # merge data
  data_2 <- mp_data[, 1:5]
  preds_2 <- clean_theory_predictions_2()
  for (i in 1:length(preds_2)) {
    preds_2[[i]] <- preds_2[[i]][, 11:15]
  }
  result <- vuong_matrix(data_2, theories = preds_2)
  colnames(result) <- names(preds_2)
  row.names(result) <- names(preds_2)
  return(result)
}
create_vuong_table_2_mp2 <- function() {
  # merge data
  data_2 <- mp_data[, 6:10]
  preds_2 <- clean_theory_predictions_2()
  for (i in 1:length(preds_2)) {
    preds_2[[i]] <- preds_2[[i]][, 16:20]
  }
  result <- vuong_matrix(data_2, theories = preds_2)
  colnames(result) <- names(preds_2)
  row.names(result) <- names(preds_2)
  return(result)
}

Table 2: 3-action games
create_vuong_table_3_ac <- function() {
  # merge data
  data_3 <- ac_data
  preds_3 <- clean_theory_predictions_3()
  for (i in 1:length(preds_3)) {
    preds_3[[i]] <- preds_3[[i]][, 1:10]
  }
  result <- vuong_matrix(data_3, theories = preds_3)
  colnames(result) <- names(preds_3)
  row.names(result) <- names(preds_3)
  return(result)
}

create_vuong_table_3_rsp1 <- function() {
  # merge data
  data_3 <- rsp_data[, 1:5]
  preds_3 <- clean_theory_predictions_3()
  for (i in 1:length(preds_3)) {
    preds_3[[i]] <- preds_3[[i]][, 11:15]
  }
  result <- vuong_matrix(data_3, theories = preds_3)
  colnames(result) <- names(preds_3)
  row.names(result) <- names(preds_3)
  return(result)
}

create_vuong_table_3_rsp2 <- function() {
  # merge data
  data_3 <- rsp_data[, 6:10]
  preds_3 <- clean_theory_predictions_3()
  for (i in 1:length(preds_3)) {
    preds_3[[i]] <- preds_3[[i]][, 16:20]
  }
  result <- vuong_matrix(data_3, theories = preds_3)
  colnames(result) <- names(preds_3)
  row.names(result) <- names(preds_3)
  return(result)
}


## Recreating tables from the Online Appendix
### Predictions

### Log-likelihoods
create_likelihood_tex_tables_2 <- function() {
  output_table <- c()
  pred_2 <- clean_theory_predictions_2()
  data_2 <- cbind(hdg_data, mp_data)
  for (i in 1:14) {
    output_table <- rbind(output_table, get_log_lh(data_2, prediction = pred_2[[i]]))
  }
  rownames(output_table) <- names(pred_2)
  colnames(output_table) <- c("T01", "T02", "T03", "T04", "T05", "T06", "T07", "T08", "T09", "T10", "T11", "T12", "T13", "T14", "T15", "T16", "T17", "T18", "T19", "T20")
  return(output_table)
}

create_likelihood_tex_tables_3 <- function(game = "AC") {
  # AC or RSP
  output_table <- c()
  names <- c()
  if (game == "RSP") {
    for (i in 1:14) {
      output_table <- rbind(output_table, get_log_lh(rsp_data, prediction = t(all_theories_3[[i]]@predictions_RSP)))
      names <- c(names, all_theories_3[[i]]@short)
    }
  } else {
    for (i in 1:14) {
      output_table <- rbind(output_table, get_log_lh(ac_data, prediction = t(all_theories_3[[i]]@predictions_HDG)))
      names <- c(names, all_theories_3[[i]]@short)
    }
  }
  rownames(output_table) <- names
  output_table <- cbind(output_table, rowSums(output_table))
  if (game == "RSP") {
    output_table_asym <- cbind(output_table[, 1:5], rowSums(output_table[, 1:5]))
    output_table_sym <- cbind(output_table[, 6:10], rowSums(output_table[, 6:10]))
    colnames(output_table) <- c("T31", "T32", "T33", "T34", "T35", "T36", "T37", "T38", "T39", "T40", "SUM")
    colnames(output_table_asym) <- c("T31", "T32", "T33", "T34", "T35", "SUM")
    colnames(output_table_sym) <- c("T36", "T37", "T38", "T39", "T40", "SUM")
    print(xtable(output_table_asym, type = "latex"))
    print(xtable(output_table_sym, type = "latex"))
  } else {
    colnames(output_table) <- c("T21", "T22", "T23", "T24", "T25", "T26", "T27", "T28", "T29", "T30", "SUM")
  }
  return(output_table)
}

create_likelihood_tex_tables_3 <- function(game = "AC") {
  # AC or RSP
  output_table <- c()
  names <- c()
  if (game == "RSP") {
    for (i in 1:14) {
      output_table <- rbind(output_table, get_log_lh(rsp_data, prediction = t(all_theories_3[[i]]@predictions_RSP)))
      names <- c(names, all_theories_3[[i]]@short)
    }
  } else {
    for (i in 1:14) {
      output_table <- rbind(output_table, get_log_lh(ac_data, prediction = t(all_theories_3[[i]]@predictions_HDG)))
      names <- c(names, all_theories_3[[i]]@short)
    }
  }
  rownames(output_table) <- names
  output_table <- cbind(output_table, rowSums(output_table))
  if (game == "RSP") {
    output_table_asym <- cbind(output_table[, 1:5], rowSums(output_table[, 1:5]))
    output_table_sym <- cbind(output_table[, 6:10], rowSums(output_table[, 6:10]))
    colnames(output_table) <- c("T31", "T32", "T33", "T34", "T35", "T36", "T37", "T38", "T39", "T40", "SUM")
    colnames(output_table_asym) <- c("T31", "T32", "T33", "T34", "T35", "SUM")
    colnames(output_table_sym) <- c("T36", "T37", "T38", "T39", "T40", "SUM")
    print(xtable(output_table_asym, type = "latex"))
    print(xtable(output_table_sym, type = "latex"))
  } else {
    colnames(output_table) <- c("T21", "T22", "T23", "T24", "T25", "T26", "T27", "T28", "T29", "T30", "SUM")
  }
  return(output_table)
}


### Vuong Scores


create_vuong_table_2 <- function() {
  # merge data
  data_2 <- cbind(hdg_data, mp_data)
  preds_2 <- clean_theory_predictions_2()
  result <- vuong_matrix(data_2, theories = preds_2)
  colnames(result) <- names(preds_2)
  row.names(result) <- names(preds_2)
  return(result)
}

create_vuong_table_3 <- function() {
  # merge data
  data_3 <- cbind(ac_data, rsp_data)
  preds_3 <- clean_theory_predictions_3()
  result <- vuong_matrix(data_3, theories = preds_3)
  colnames(result) <- names(preds_3)
  row.names(result) <- names(preds_3)
  return(result)
}

create_vuong_table_all <- function() {
  # (llr_2 + llr_3)/((variance_2 + variance_3))^(.5)
  data_2 <- cbind(hdg_data, mp_data)
  data_3 <- cbind(ac_data, rsp_data)
  preds_2 <- clean_theory_predictions_2()
  preds_3 <- clean_theory_predictions_3()
  names <- c()
  num_theories <- 14
  result <- matrix(, nrow = num_theories, ncol = num_theories)
  for (i in 1:num_theories) {
    for (j in 1:num_theories) {
      variance_2 <- get_variance_of_llr(data_2, preds_2[[i]], preds_2[[j]])
      variance_3 <- get_variance_of_llr(data_3, preds_3[[i]], preds_3[[j]])
      llr_2 <- get_llr(data_2, preds_2[[i]], preds_2[[j]])
      llr_3 <- get_llr(data_3, preds_3[[i]], preds_3[[j]])
      result[i, j] <- (llr_2 + llr_3) / (variance_2 + variance_3)^(.5)
    }
  }
  colnames(result) <- names(preds_3)
  row.names(result) <- names(preds_3)
  return(result)
}
### Testing theories individually
reproduce_2_chi_sq_mp <- function() {
  output <- c()
  num_theories <- ncol(all_theories_2)
  for (i in 1:num_theories) {
    pred_MP <- rbind(all_theories_2[, i]$MPpredictions, 1 - all_theories_2[, i]$MPpredictions)
    # pred_HDG <- rbind(all_theories_2[,theory]$HDGpredictions, 1- all_theories_2[,theory]$HDGpredictions)
    output <- rbind(output, get_chi_sq(mp_data, pred_MP))
  }
  return(output)
}

reproduce_2_chi_sq_hdg <- function() {
  output <- c()
  num_theories <- ncol(all_theories_2)
  for (i in 1:num_theories) {
    pred <- rbind(all_theories_2[, i]$HDGpredictions, 1 - all_theories_2[, i]$HDGpredictions)
    output <- rbind(output, get_chi_sq(hdg_data, pred))
  }
  return(output)
}

reproduce_3_chi_sq_hdg <- function() {
  output <- c()
  num_theories <- length(all_theories_3)
  for (i in 1:num_theories) {
    pred <- t(all_theories_3[[i]]@predictions_HDG)
    # pred_HDG <- rbind(all_theories_2[,theory]$HDGpredictions, 1- all_theories_2[,theory]$HDGpredictions)
    output <- rbind(output, get_chi_sq(ac_data, pred))
  }
  return(output)
}

reproduce_3_chi_sq_ac <- function() {
  output <- c()
  num_theories <- length(all_theories_3)
  for (i in 1:num_theories) {
    pred <- t(all_theories_3[[i]]@predictions_RSP)
    # pred_HDG <- rbind(all_theories_2[,theory]$HDGpredictions, 1- all_theories_2[,theory]$HDGpredictions)
    output <- rbind(output, get_chi_sq(rsp_data, pred))
  }
  return(output)
}


